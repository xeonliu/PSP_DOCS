<html lang="en">
<head>
<title>fmacvideo-Overview</title>
<meta http-equiv="Content-Type" content= text/html; charset=iso-8859-1>
<meta http-equiv="Content-Script-Type" content="text/javascript">
<meta http-equiv="Content-Style-Type" content="Text/css>
<meta name="Author"Content=" Sony Computer Entertainment Inc.">
</head>
<body bgcolor="#ffffff" text="#000000" >
<a name=TOP></a>
<table WIDTH="100%">
<tr><td>
<h3>PSP&trade; Programmer Tool Runtime Library Release 6.3.0</h3>
</td>
</tr>
</table>
<hr noshade size=6>
<center><h1>
Flash Media Access Video Overview
</h1></center>
</a>
<!-- sce_hd1 -->

<!-- sce_hd3 -->
<a name="Heading3_1">
<h2>
 1 <!-- hp --><b>Library Overview</b>
<hr noshade>
</h2>


<!-- sce_hd4 -->
<a name="Heading4_1_1">
<h3>
<a href="#Heading3_1"> 1. </a>1 
<!-- hp1 --><b>Function Overview and Features</b><br>
</a>
</h3>
<div style="margin-left:50px;">The flash media access video library provides features for safely saving video data in the video directory on flash media such as a Memory Stick&trade;.<br>The library enables video data such as that generated with a library such as an AVI generation library, or a promotional video contained in an application to be written to a directory on the flash media that will be recognized by system software (/VIDEO/level-1/level-2(*1)/video-file) without the application having to know about the directory structure, remaining capacity of the flash media, etc.<br>*1: Level-2 can be omitted<br></div>

<!-- sce_hd4 -->
<a name="Heading4_1_2">
<h3>
<a href="#Heading3_1"> 1. </a>2 
<!-- hp1 --><b>Features</b><br>
</a>
</h3>
<div style="margin-left:40px;"><ul>
<li> Power lock processing is performed at the appropriate time.
<li> Memory Stick&trade; insertion and removal are monitored.
<li> Sleep and sleep cancellation are monitored.
<li> Files can be saved without the application having to know the structure of the flash media directory and whether it exists.
<li> Files can be saved without the application having to calculate the remaining capacity of the flash media.
<li> Files can be saved without the application having to check the write protection of the flash media.
<li> Multiple files can be handled without the application having to keep track of the numeric suffixes automatically assigned to files.
</ul></div>

<!-- sce_hd4 -->
<a name="Heading4_1_3">
<h3>
<a href="#Heading3_1"> 1. </a>3 
<!-- hp1 --><b>Related Files</b><br>
</a>
</h3>
<div style="margin-left:50px;">The following files are required to use the flash media access video library.<br>Because sleep/sleep cancellation is monitored internally, the power service stub library must be linked.<br><br></div>
<div style="margin-left:90px;">
<table border=1>
<tr>
<td valign="TOP" bgcolor="#cccccc">&nbsp;&nbsp;<b>Category</b>&nbsp;&nbsp;</td>
<td valign="TOP" bgcolor="#cccccc">&nbsp;&nbsp;<b>File Name</b>&nbsp;&nbsp;</td>
</tr>
<tr>
<td valign="TOP">&nbsp;&nbsp;Static link library file&nbsp;&nbsp;</td>
<td valign="TOP">&nbsp;&nbsp;libfmacvideo.a&nbsp;&nbsp;</td>
</tr>
<tr>
<td valign="TOP">&nbsp;&nbsp;Stub library file&nbsp;&nbsp;</td>
<td valign="TOP">&nbsp;&nbsp;power_stub.a&nbsp;&nbsp;</td>
</tr>
<tr>
<td valign="TOP">&nbsp;&nbsp;Header file&nbsp;&nbsp;</td>
<td valign="TOP">&nbsp;&nbsp;fmacvideo.h&nbsp;&nbsp;</td>
</tr>
</table>
</div>
<br>

<!-- sce_hd4 -->
<a name="Heading4_1_4">
<h3>
<a href="#Heading3_1"> 1. </a>4 
<!-- hp1 --><b>Sample Programs</b><br>
</a>
</h3>

<!-- sce_title -->
<a Name ="HeadingT_1_4_1">
<div style="margin-left:40px;"><h4><b>devkit/sample/fmac/video_simple</b><br><br></h4></div></a>

<div style="margin-left:67px;">This sample adds the processing step of saving movie data on flash media to the devkit/sample/graphics/simple sample.<br></div>

<!-- sce_title -->
<a Name ="HeadingT_1_4_2">
<div style="margin-left:40px;"><h4><b>devkit/sample/avi/avi_wrapper</b><br><br></h4></div></a>

<div style="margin-left:67px;">This directory contains sample source code that shows how to use libraries such as avienc, jpegenc, fmacvideo, or u-law to create an AVI (motion JPEG) movie. The samples under devkit/sample/avi use the source header found here. For details, refer to the readme in each sample.<br>By studying the source code, you can understand the processing flow involved in creating a movie. This includes encoding the contents of the frame buffer as Motion JPEG, encoding PCM waveform data as u-law compressed data, etc. and then merging the encoded results into an AVI file, and saving it on flash media.<br></div>

<!-- sce_title -->
<a Name ="HeadingT_1_4_3">
<div style="margin-left:40px;"><h4><b>devkit/sample/avi/avi_wrap_template</b><br><br></h4></div></a>

<div style="margin-left:67px;">This directory contains a header template that you can use for including the source and header located under avi_wrapper in a title application. Copy this template into your title application and change it as necessary according to your title's specifications.<br></div>

<!-- sce_title -->
<a Name ="HeadingT_1_4_4">
<div style="margin-left:40px;"><h4><b>devkit/sample/avi/rec_simple</b><br><br></h4></div></a>

<div style="margin-left:67px;">This sample adds a silent movie recording feature to the simple graphics sample program devkit/sample/graphics/simple.<br>Only main.c was changed to add the movie recording feature (the Makefile must also be changed accordingly for the environment).<br>By looking at the differences between this sample program and devkit/sample/graphics/simple, you can see where the changes were made.<br>Use this as a reference for recording digital movies of materials for promotional videos.<br>Note that silent AVI is not supported by system software.<br></div>

<!-- sce_title -->
<a Name ="HeadingT_1_4_5">
<div style="margin-left:40px;"><h4><b>devkit/sample/avi/rec_at3mix</b><br><br></h4></div></a>

<div style="margin-left:67px;">This sample adds a movie recording feature to the sound and graphics sample program devkit/sample/sound/at3mix.<br>Only main.c and soundthread.* were changed to add the movie recording feature (the Makefile also must be changed accordingly for the environment).<br>By looking at the differences between this sample program and devkit/sample/sound/at3mix, you can see where the changes were made.<br></div>

<!-- sce_title -->
<a Name ="HeadingT_1_4_6">
<div style="margin-left:40px;"><h4><b>devkit/sample/avi/rec_p3da_revolve</b><br><br></h4></div></a>

<div style="margin-left:67px;">This sample adds a movie recording feature to the 3D audio sample program devkit/sample/sound/p3da_revolve.<br>Only main.c and sound.* were changed to add the movie recording feature (the Makefile must also be changed accordingly for the environment).<br>Note: key.* was also changed separately from the movie recording feature.<br>By looking at the differences between this sample program and devkit/sample/sound/p3da_revolve, you can see where the changes were made.<br></div>

<!-- sce_title -->
<a Name ="HeadingT_1_4_7">
<div style="margin-left:40px;"><h4><b>devkit/sample/avi/rec_starmix</b><br><br></h4></div></a>

<div style="margin-left:67px;">This sample adds a movie recording feature to the sound and graphics sample program devkit/sample/sound/starmix.<br>Only main.c and at3plus.* were changed to add the movie recording feature (the Makefile must also be changed accordingly for the environment).<br>By looking at the differences between this sample program and devkit/sample/sound/starmix, you can see where the changes were made.<br></div>

<!-- sce_title -->
<a Name ="HeadingT_1_4_8">
<div style="margin-left:40px;"><h4><b>devkit/sample/avi/rec_at3doubleplay</b><br><br></h4></div></a>

<div style="margin-left:67px;">This sample adds a movie recording feature to the sound and graphics sample program devkit/sample/sound/at3doubleplay.<br>This sample is an applied version. You should refer to a different sample to learn about basic features of AVI movie recording.<br>This sample uses a simple replay function to save controller information and perform movie recording as replay recording. BGM is played separately during movie recording.<br><br><br></div>

<!-- sce_hd3 -->
<a name="Heading3_2">
<h2>
 2 <!-- hp --><b>Overview of the Usage Procedure</b>
<hr noshade>
</h2>

<div style="margin-left:50px;">The following procedure can be used to access flash media.<br>Be sure to perform appropriate error checking after each function call.<br></div>

<!-- sce_hd5 -->
<div style="margin-left:40px;"><a name="Heading5_2_1"><h4>
(1)&nbsp;<b>Allocate an area to adjust the write alignment</b><br></h4>
</a></div>
<div style="margin-left:67px;">This step is generally not necessary.<br>The <i>offset</i> specified in the file append function <a href="../peripheral/fmacvideo-Reference-English.htm#sceFmacVideoAdd">sceFmacVideoAdd</a>() must be aligned on 64 bytes. However, if this cannot be done easily when developing the application, then you should allocate a write alignment adjustment work area. By specifying this area, the library will handle the alignment internally. The required work area size is SCE_FMAC_PARAM_WRTALIGN_WORK. The usage starting address (leading address) must have 64-byte alignment. This area should be saved within the application until the library is terminated.<br></div>

<!-- sce_hd5 -->
<div style="margin-left:40px;"><a name="Heading5_2_2"><h4>
(2)&nbsp;<b>Initialize the library</b><br></h4>
</a></div>
<div style="margin-left:67px;">Call the initialization function <a href="../peripheral/fmacvideo-Reference-English.htm#sceFmacVideoInit">sceFmacVideoInit</a>() to initialize the library. At this time, a power service callback, FAT Filesystem For Memory Stick&trade; (FAT forMS) callback, and thread for monitoring these callbacks are created and started. After initialization successfully completes, these callbacks and the thread will stay resident until the library is terminated (if an initialization error occurs, these callbacks and the monitoring thread will not be created or started). The priority of the monitoring thread is set one level higher (one value lower) than the thread that called the initialization function.<br></div>

<!-- sce_hd5 -->
<div style="margin-left:40px;"><a name="Heading5_2_3"><h4>
(3)&nbsp;<b>Set appropriate initialization parameters</b><br></h4>
</a></div>
<div style="margin-left:67px;">Set initialization parameters (<a href="../peripheral/fmacvideo-Reference-English.htm#SceFmacVideoParam">SceFmacVideoParam</a>) appropriately for the application's specifications. The character code for specifiable strings is UTF-8. String length is measured in bytes (including the character terminator). Note that string length is not the same as the number of characters.<br></div>

<!-- sce_hd5 -->
<div style="margin-left:40px;"><a name="Heading5_2_4"><h4>
(4)&nbsp;<b>Start the library</b><br></h4>
</a></div>
<div style="margin-left:67px;">Specify the initialization parameters set in step (2) to the starting function <a href="../peripheral/fmacvideo-Reference-English.htm#sceFmacVideoStart">sceFmacVideoStart</a>().<br></div>

<!-- sce_hd5 -->
<div style="margin-left:40px;"><a name="Heading5_2_5"><h4>
(5)&nbsp;<b>Prepare data to be written</b><br></h4>
</a></div>
<div style="margin-left:67px;">Prepare the data to be written. Buffer any video data, including that generated with libraries such as the AVI generation library or included in the application. The usage starting address (leading address) of the buffer must have 64-byte alignment.<br></div>

<!-- sce_hd5 -->
<div style="margin-left:40px;"><a name="Heading5_2_6"><h4>
(6)&nbsp;<b>Write prepared data on flash media</b><br></h4>
</a></div>
<div style="margin-left:67px;">Use the save new file function <a href="../peripheral/fmacvideo-Reference-English.htm#sceFmacVideoWrite">sceFmacVideoWrite</a>() to write the data as a file. If all data cannot be written at once, use <a href="../peripheral/fmacvideo-Reference-English.htm#sceFmacVideoAdd">sceFmacVideoAdd</a>() later to append to it. Make sure that the offset value also has 64-byte alignment when appending data. When a write alignment adjustment work area is allocated in step (1), the application will operate even if the offset value does not have 64-byte alignment. However, because this requires some overhead, make every effort to ensure that it can be written with 64-byte alignment.<br>When <a href="../peripheral/fmacvideo-Reference-English.htm#sceFmacVideoAdd">sceFmacVideoAdd</a>() is used to append data, use the function <a href="../peripheral/fmacvideo-Reference-English.htm#sceFmacVideoCheck">sceFmacVideoCheck</a>() to predetermine whether the data can be saved. An approximate size may be used for this check. Specify a larger size than necessary (for example: the maximum size of a generated AVI file). If the specified value is too small, it will not be possible to determine whether the data can be saved, which could lead to problems later. Also, if considerable time will elapse between library initialization and the writing of data, or between the buffering of data and the writing of data, <a href="../peripheral/fmacvideo-Reference-English.htm#sceFmacVideoCheckStatus">sceFmacVideoCheckStatus</a>() should be routinely called to check if sleep state was entered or if the Memory Stick&trade; was inserted or removed. <br>If these events cannot be checked with <a href="../peripheral/fmacvideo-Reference-English.htm#sceFmacVideoCheckStatus">sceFmacVideoCheckStatus</a>() but they end up being detected by the next API call instead, then if that API call is necessarily delayed, the response to the event will be delayed, and that could be disadvantageous to the user. (For example, if the application specification requires that while AVI data is being generated, data will be saved to the Memory Stick&trade; after 30 seconds of buffering, then no error will occur for at most 30 seconds after sleep is started and canceled, and the error will end up occurring 30 seconds after processing resumes.)<br></div>

<!-- sce_hd5 -->
<div style="margin-left:40px;"><a name="Heading5_2_7"><h4>
(7)&nbsp;<b>When sleep/sleep cancellation or Memory Stick&trade; insertion/removal is detected</b><br></h4>
</a></div>
<div style="margin-left:67px;">When these events are detected, an error will occur in all APIs that access the <br>Memory Stick&trade;. Use <a href="../peripheral/fmacvideo-Reference-English.htm#sceFmacVideoStart">sceFmacVideoStart</a>() from step (4) to restore the library to a usable state. However, if <a href="../peripheral/fmacvideo-Reference-English.htm#sceFmacVideoStart">sceFmacVideoStart</a>() is used immediately after a sleep/sleep cancellation error occurs, an error may occur during sleep cancellation. Although it is acceptable for the application to automatically attempt a retry, unlimited retries or a busy loop may result when an unrecoverable error occurs.<br></div>

<!-- sce_hd5 -->
<div style="margin-left:40px;"><a name="Heading5_2_8"><h4>
(8)&nbsp;<b>Shutdown processing</b><br></h4>
</a></div>
<div style="margin-left:67px;">Call the termination function <a href="../peripheral/fmacvideo-Reference-English.htm#sceFmacVideoTerm">sceFmacVideoTerm</a>() to perform shutdown processing. Be sure to call this function to shut down the initialized library once you are finished using it. This function terminates and removes the power service and FAT ForMS callbacks that were generated and started during initialization, as well as the monitoring thread. <br><br></div>

<!-- sce_hd3 -->
<a name="Heading3_3">
<h2>
 3 <!-- hp --><b>Saving Files</b>
<hr noshade>
</h2>


<!-- sce_hd4 -->
<a name="Heading4_3_1">
<h3>
<a href="#Heading3_3"> 3. </a>1 
<!-- hp1 --><b>Characters in Directory or File Names</b><br>
</a>
</h3>
<div style="margin-left:50px;">The character code that can be used for files or directories is UTF-8 (no BOM).<br>The following characters can be used.<br></div>
<div style="margin-left:40px;"><ul>
<li> Half-width symbols:  \ " / : &lt; &gt; | * ?
<li> Surrogate pairs (characters that use 4 bytes in UTF-16) 
</ul></div>

<!-- sce_hd4 -->
<a name="Heading4_3_2">
<h3>
<a href="#Heading3_3"> 3. </a>2 
<!-- hp1 --><b> Forced Overwriting of Files</b><br>
</a>
</h3>
<div style="margin-left:50px;">When "overwrite file" is specified in the "file writing rules" during initialization, even if a file already exists, it will be ignored and overwritten.<br>This function can be used when verifying overwriting separately within the application, or it can be used to rewrite the same data such as with promotional videos.<br>However, we recommend that you explicitly explain that the data will be overwritten in the application or application instruction manual.<br></div>

<!-- sce_hd4 -->
<a name="Heading4_3_3">
<h3>
<a href="#Heading3_3"> 3. </a>3 
<!-- hp1 --><b> File Suffix Numbering</b><br>
</a>
</h3>
<div style="margin-left:50px;">When "assign suffix number when saving file" is specified in the "file writing rules" during initialization, the target directory is searched and if a free suffix number is found, the suffix number will be assigned to the file. If a number is free because the user has deleted a file (as in the example below) that number is used for the suffix number.<br></div>

<!-- sce_title -->
<a Name ="HeadingT_3_3_9">
<div style="margin-left:40px;"><h4><b>[Example]</b><br><br></h4></div></a>

<div style="margin-left:67px;">/VIDEO/sample/movie-output/test-movie001.avi<br>/VIDEO/sample/movie-output/test-movie002.avi<br>/VIDEO/sample/movie-output/test-movie004.avi &lt;- 003 is missing<br>        :<br>        &darr;<br>/VIDEO/sample/movie-output/test-movie001.avi<br>/VIDEO/sample/movie-output/test-movie002.avi<br>/VIDEO/sample/movie-output/test-movie003.avi &lt;- Saved as 003<br>/VIDEO/sample/movie-output/test-movie004.avi<br>        :<br></div>
<div style="margin-left:50px;">When the target directory is searched, upper and lower case is not distinguished for half-width (single-byte) alphabetic characters. For example, the following cases are given numbered suffixes as if they were the same file.<br></div>

<!-- sce_title -->
<a Name ="HeadingT_3_3_10">
<div style="margin-left:40px;"><h4><b>[Example]</b><br><br></h4></div></a>

<div style="margin-left:67px;">/VIDEO/Sample/Output-Video/Test-Movie001.avi<br>/VIDEO/Sample/Output-Video/TEST-MOVIE002.avi<br>/VIDEO/Sample/OUTPUT-VIDEO/Test-Movie003.avi<br>/VIDEO/SAMPLE/Output-Video/Test-Movie004.avi<br>/video/SAMPLE/Output-Video/Test-Movie005.avi<br>/VIDEO/SAMPLE/Output-Video/Test-Movie006.AVI<br>/VIDEO/SAMPLE/OUTPUT-VIDEO/TEST-MOVIE007.AVI<br>        &darr;<br>/VIDEO/Sample/Output-Video/Test-Movie001.avi<br>/VIDEO/Sample/Output-Video/TEST-MOVIE002.avi<br>/VIDEO/Sample/OUTPUT-VIDEO/Test-Movie003.avi<br>/VIDEO/SAMPLE/Output-Video/Test-Movie004.avi<br>/video/SAMPLE/Output-Video/Test-Movie005.avi<br>/VIDEO/SAMPLE/Output-Video/Test-Movie006.AVI<br>/VIDEO/SAMPLE/OUTPUT-VIDEO/TEST-MOVIE007.AVI<br>/VIDEO/Sample/Output-Video/Test-Movie008.avi<br><br></div>

<!-- sce_hd3 -->
<a name="Heading3_4">
<h2>
 4 <!-- hp --><b>Precautions</b>
<hr noshade>
</h2>


<!-- sce_hd4 -->
<a name="Heading4_4_1">
<h3>
<a href="#Heading3_4"> 4. </a>1 
<!-- hp1 --><b> Initialization Parameters</b><br>
</a>
</h3>
<div style="margin-left:50px;">When a write alignment adjustment work area is allocated, save that work area from the time when the library is successfully initialized until it is terminated. Do not directly access the work area.<br></div>

<!-- sce_hd4 -->
<a name="Heading4_4_2">
<h3>
<a href="#Heading3_4"> 4. </a>2 
<!-- hp1 --><b>Checking the Available Space</b><br>
</a>
</h3>
<div style="margin-left:50px;">When writing once, the available space does not need to be checked in advance. If there is insufficient space, the write function will return the required size.<br>However, when writing multiple data by dividing it into multiple segments, the application cannot display the required space because it can only return an error message indicating that the data could not be written. When writing multiple data, determine the approximate size in advance and use <a href="../peripheral/fmacvideo-Reference-English.htm#sceFmacVideoCheck">sceFmacVideoCheck</a>() to check whether sufficient space is available. Note that it is acceptable for a larger value to be displayed as the required space. However, the decision cannot be made properly if too small a value is specified (for example: use the maximum size of a generated AVI file).<br></div>

<!-- sce_hd4 -->
<a name="Heading4_4_3">
<h3>
<a href="#Heading3_4"> 4. </a>3 
<!-- hp1 --><b> Power Lock</b><br>
</a>
</h3>
<div style="margin-left:50px;">Because power lock processing is performed at appropriate times by the library, the start of sleep or power off (standby) processing can be delayed in some situations. This is to protect the flash media from problems such as loss of data or damage to the device itself, because of a user-initiated suspend or power-off operation while accessing the flash media. When using this library, do not have the application perform power lock processing independently.<br></div>

<!-- sce_hd4 -->
<a name="Heading4_4_4">
<h3>
<a href="#Heading3_4"> 4. </a>4 
<!-- hp1 --><b>When Using The Library to Write to Flash Media</b><br>
</a>
</h3>
<div style="margin-left:50px;">Although this library is not a system utility, it enables files to be written to flash media safely and easily.<br>When it is implemented in an application, it may be used in a product as long as there is no conflict with the application specifications (plans). Discuss this in each region when presenting specifications (plans).<br></div>

<!-- sce_hd4 -->
<a name="Heading4_4_5">
<h3>
<a href="#Heading3_4"> 4. </a>5 
<!-- hp1 --><b>Processing After an Error Caused by Sleep or Memory Stick&trade; Insertion/Removal</b><br>
</a>
</h3>
<div style="margin-left:50px;">Sleep/sleep cancellation and Memory Stick&trade; insertion/removal are monitored by the library. A function will return an error if the device is put to sleep or if the Memory Stick&trade; is inserted/removed before write processing or during subdivided write processing. This is because there is no guarantee that the same Memory Stick&trade; will still be inserted after these events occur.<br>If writing to an AVI file does not end properly, the file might become corrupted.<br>Ensure that the application displays a message to that effect before the write operation starts and also when an error occurs. The application can then accept a user action to delete the unnecessary file.<br><br></div>
<p><p><hr>
<div ALIGN="right">
    &copy;2009 Sony Computer Entertainment Inc.  All Rights Reserved.<br>
    SCE CONFIDENTIAL
</div>
</body>
</html>

<html lang="jp">
<head>
<title>PSPNET_Adhoc_Discover-Overview</title>
<meta http-equiv="Content-Type" content= text/html; charset=Shift_JIS>
<meta http-equiv="Content-Script-Type" content="text/javascript">
<meta http-equiv="Content-Style-Type" content="Text/css>
<meta name="Author"Content=" Sony Computer Entertainment Inc.">
</head>
<body bgcolor="#ffffff" text="#000000" >
<a name=TOP></a>
<table WIDTH="100%">
<tr><td>
<h3>PSP&reg; Programmer Tool Runtime Library Release 6.6.0</h3>
</td>
</tr>
</table>
<hr noshade size=6>
<center><h1>
pspnet_adhoc_discover
</h1></center>
</a>
<!-- sce_hd1 -->

<!-- sce_hd3 -->
<a name="Heading3_1">
<h2>
 1 <!-- hp --><b>ライブラリ概要</b>
<hr noshade>
</h2>


<!-- sce_hd4 -->
<a name="Heading4_1_1">
<h3>
<a href="#Heading3_1"> 1. </a>1 
<!-- hp1 --><b>機能の概要と特徴</b><br>
</a>
</h3>
<div style="margin-left:50px;">アドホックディスカバライブラリ（pspnet_adhoc_discover）は、本ライブラリを起動中の複数の端末同士がお互いを探索し、発見した端末とアドホックネットワークに接続する機能を提供するライブラリです。<br><br>アドホックディスカバライブラリによる近傍端末の探索では、WLANモジュールを間欠的に動作させることで、低消費電力による探索を行うことが可能です。また、PSP&reg; (PlayStation&reg;Portable)をサスペンド状態にしたまま端末の探索を行うことで、さらに低消費電力による探索を可能とする機能も提供します。<br><br>本ライブラリをバックグラウンドで実行することにより、ゲーム実行中に対戦相手を探したり、同じゲームを実行している近傍の端末とメッセージの交換をする目的などに使用できます。<br><br></div>

<div align=center>
<p>
<img src="gif/PSPNET_Adhoc_Discover-Overview-Japanese001.gif">
</div>
<br>
<div style="margin-left:50px;"><br></div>

<!-- sce_fignum -->
<div align=center>
<p>
<b>図 1 アドホックディスカバライブラリ機能例1（ゲーム実行中）</b><br>
</div>
<br>
<div style="margin-left:50px;"><br></div>

<div align=center>
<p>
<img src="gif/PSPNET_Adhoc_Discover-Overview-Japanese002.gif">
</div>
<br>
<div style="margin-left:50px;"><br></div>

<!-- sce_fignum -->
<div align=center>
<p>
<b>図 2 アドホックディスカバライブラリ機能例2（サスペンド状態）</b><br>
</div>
<br>
<div style="margin-left:50px;">また、ゲーム実行中に探索している端末とサスペンド状態で探索している端末の間でも、互いに発見することができます。<br></div>

<div align=center>
<p>
<img src="gif/PSPNET_Adhoc_Discover-Overview-Japanese003.gif">
</div>
<br>
<div style="margin-left:50px;"><br></div>

<!-- sce_fignum -->
<div align=center>
<p>
<b>図 3 アドホックディスカバライブラリ機能例3（ゲーム実行中端末とサスペンド状態端末）</b><br>
</div>
<br>

<!-- sce_hd4 -->
<a name="Heading4_1_2">
<h3>
<a href="#Heading3_1"> 1. </a>2 
<!-- hp1 --><b>関連ファイル</b><br>
</a>
</h3>
<div style="margin-left:90px;">
<table border=1>
<tr>
<td valign="TOP" bgcolor="#cccccc">&nbsp;&nbsp;<b>カテゴリ</b>&nbsp;&nbsp;</td>
<td valign="TOP" bgcolor="#cccccc">&nbsp;&nbsp;<b>ファイル名</b>&nbsp;&nbsp;</td>
</tr>
<tr>
<td valign="TOP">&nbsp;&nbsp;ヘッダファイル&nbsp;&nbsp;</td>
<td valign="TOP">&nbsp;&nbsp;pspnet_adhoc_discover.h&nbsp;&nbsp;</td>
</tr>
<tr>
<td valign="TOP">&nbsp;&nbsp;スタブライブラリファイル&nbsp;&nbsp;</td>
<td valign="TOP">&nbsp;&nbsp;pspnet_adhoc_discover_stub.a&nbsp;&nbsp;</td>
</tr>
<tr>
<td valign="TOP">&nbsp;&nbsp;weakインポートスタブライブラリファイル&nbsp;&nbsp;</td>
<td valign="TOP">&nbsp;&nbsp;pspnet_adhoc_discover_stub_weak.a&nbsp;&nbsp;</td>
</tr>
</table>
</div>
<br>
<br>
<div style="margin-left:50px;">使用例については以下のサンプルを御覧ください。<br></div>
</ol>
<div style="margin-left:40px;"><ul>
<li> HostDiscoverモード（ゲーム実行中に探索）の使用例
</ul></div>
<div style="margin-left:70px;"><ul>
<li> devkit/sample/net/adhoc/adhoc_discover/moonball
<li> devkit/sample/net/adhoc/adhoc_discover/stars
</ol></div>
<div style="margin-left:40px;"><ul>
<li> WoLモード（サスペンド状態で探索）の使用例
</ul></div>
<div style="margin-left:70px;"><ul>
<li> devkit/sample/net/adhoc/adhoc_discover/wol_picture
</ul></div>
</ul>
<div style="margin-left:50px;"><br>APIリファレンスについては、アドホックディスカバライブラリ（pspnet_adhoc_discover）リファレンスを御覧ください。<br><br></div>

<!-- sce_hd3 -->
<a name="Heading3_2">
<h2>
 2 <!-- hp --><b>動作概要</b>
<hr noshade>
</h2>

<div style="margin-left:50px;">アドホックディスカバライブラリの内部動作は、次に示す2つのフェーズからなります。<br></div>
</ol>
<div style="margin-left:55px;"><ol>
<li VALUE=1> 近傍端末の探索フェーズ</li>
</ol></div>
<div style="margin-left:70px;"><ul>
<li> HostDiscoverモード
<li> WoLモード
</ol></div>
<div style="margin-left:55px;"><ol>
<li VALUE=2> アドホックネットワークへの接続フェーズ</li>
</ul>
</ol></div>
<div style="margin-left:50px;">近傍端末の探索にはさらに2つのモードが存在し、アプリケーションから指定されたモードで探索を行います。以下では、アドホックディスカバライブラリにおける各動作フェーズと探索フェーズにおける各探索モードについて使用例と併せて説明します。<br><br>探索フェーズでは指定されたモードによって動作や想定される使用例が異なります。しかし、探索フェーズで近傍端末を発見した後のアドホックネットワークへの接続フェーズの動作は両探索モードで共通です。<br></div>

<!-- sce_hd4 -->
<a name="Heading4_2_1">
<h3>
<a href="#Heading3_2"> 2. </a>1 
<!-- hp1 --><b>近傍端末の探索フェーズ</b><br>
</a>
</h3>
<div style="margin-left:50px;">近傍端末の探索には、①ゲームを実行しながら探索を行うモード（HostDiscover）と、②PSP&reg;がサスペンド状態の間に探索を行うモード（WoL）の2つのモードがあり、ライブラリ起動時にアプリケーションから探索モードを指定します。<br></div>

<!-- sce_hd5 -->
<div style="margin-left:40px;"><a name="Heading5_2_1_1"><h4>
(1)&nbsp;<b>ゲーム実行中に探索するモード（HostDiscoverモード）</b><br></h4>
</a></div>
<div style="margin-left:67px;">HostDiscoverモードは、ゲームを実行しながらバックグラウンドで近傍端末を探索するモードです。使用例としては次のようなものが考えられます。<br></div>
<div style="margin-left:55px;"><ol>
<li VALUE=1> 1Pモードでゲームをしている最中に対戦相手を探索し、発見したら2Pモードに移行して対戦を開始する。</li>
<li VALUE=2> 同じゲームを実行中の別の端末を探索し、発見したらメッセージ・スコア・ゲームデータなどを交換する。</li>
</ol></div>
<div style="margin-left:67px;"><br>図 4、図 5は上記使用例におけるアドホックディスカバライブラリの動作と使用の流れを示しています。ライブラリの起動で近傍端末の探索を開始し、発見すると接続フェーズでアドホックネットワークへの接続を確立し、ライブラリは動作終了状態になります。アプリケーションは、アドホックディスカバライブラリを起動しライブラリが動作終了状態になるのを待機することで、近傍端末と通信可能な状態を取得でき、アドホックディスカバライブラリで確立した接続を利用して、必要な通信処理を行います。<br><br></div>
<div style="margin-left:50px;"></div>

<div align=center>
<p>
<img src="gif/PSPNET_Adhoc_Discover-Overview-Japanese004.gif">
</div>
<br>
<div style="margin-left:50px;"><br></div>

<!-- sce_fignum -->
<div align=center>
<p>
<b>図 4 HostDiscoverモードの使用例（1）</b><br>
</div>
<br>
<div style="margin-left:50px;"><br></div>

<div align=center>
<p>
<img src="gif/PSPNET_Adhoc_Discover-Overview-Japanese005.gif">
</div>
<br>
<div style="margin-left:50px;"><br></div>

<!-- sce_fignum -->
<div align=center>
<p>
<b>図 5 HostDiscoverモードの使用例（2）</b><br>
</div>
<br>

<!-- sce_hd5 -->
<div style="margin-left:40px;"><a name="Heading5_2_1_2"><h4>
(2)&nbsp;<b>サスペンド状態で探索するモード（WoLモード）</b><br></h4>
</a></div>
<div style="margin-left:67px;">WoLモードは、WLANモジュールへの電源供給を維持したままPSP&reg;をサスペンド状態にし、サスペンド状態のまま近傍端末の探索を行うことができるモードです。使用例としては次のようなものが考えられます。<br></div>
<div style="margin-left:55px;"><ol>
<li VALUE=1> PSP&reg;をサスペンドさせ、同じゲームを実行しているか、同じゲーム中からWoLモード探索のためにサスペンドしている別の端末を探索する（ここでユーザが不在となることがある）。</li>
<li VALUE=2> 目的の端末を発見したらメッセージ・スコア・ゲームデータなどを交換する。</li>
<li VALUE=3> 処理終了後に再度サスペンドする。</li>
<li VALUE=4> ユーザがPSP&reg;をレジュームさせると、データが交換されていることが分かる。</li>
</ol></div>
<div style="margin-left:67px;"><br>WoLモードによる探索中に近傍端末を発見すると、PSP&reg;は自動的にレジュームされ、アドホックネットワークへの接続フェーズを開始します。<br><br>WoLモードでの探索を開始しPSP&reg;がサスペンド状態になると、ユーザが不在となることが想定されます。WoLモード探索で発見した端末とデータ交換などの通信処理を終えた後、電力消費を抑制するために再度PSP&reg;をサスペンドさせる必要があります。アドホックディスカバライブラリでは、このような状況でPSP&reg;をサスペンドさせるために、アプリケーションからAPI呼び出しによりPSP&reg;をサスペンドさせることのできる機能を提供しています。詳細は「アプリケーション作成において必要と想定される機能や処理」の「(3)API呼び出しによるサスペンド処理」の項を御参照ください。<br><br>図 6は、WoLモードでの使用例における、アドホックディスカバライブラリの動作と使用の流れを示しています。<br><br></div>
<div style="margin-left:50px;"></div>

<div align=center>
<p>
<img src="gif/PSPNET_Adhoc_Discover-Overview-Japanese006.gif">
</div>
<br>
<div style="margin-left:50px;"><br></div>

<!-- sce_fignum -->
<div align=center>
<p>
<b>図 6 WoLモードの使用例</b><br>
</div>
<br>
<div style="margin-left:67px;">また、同じモード探索している端末同士だけでなく、HostDiscoverモードで探索する端末とWoLモードで探索する端末が互いに発見し合うことも可能です。<br></div>

<!-- sce_hd4 -->
<a name="Heading4_2_2">
<h3>
<a href="#Heading3_2"> 2. </a>2 
<!-- hp1 --><b>アドホックネットワークへの接続フェーズ</b><br>
</a>
</h3>
<div style="margin-left:50px;">探索モード実行中に近傍の端末を発見すると、探索フェーズを終了し、アドホックネットワークへの接続を行うフェーズに移ります。<br><br>アドホックネットワークへの接続フェーズでは、アドホックディスカバライブラリの内部で、アプリケーションから指定されたグループ名のアドホックネットワークの生成（Create）と、アプリケーションから指定されたグループ名のアドホックネットワークのスキャン（Scan）をランダムな時間間隔で交互に繰り返します。スキャンの結果、目的のグループ名のネットワークが見つかった場合には、そのネットワークに接続（Join）します。<br><br>アドホックディスカバライブラリでは、アドホックネットワークへ接続後<a href="../network/PSPNET_Adhocctl-Reference-Japanese.htm#sceNetAdhocctlGetPeerList">sceNetAdhocctlGetPeerList</a>()により1つ以上の端末情報のリストを取得した状態を、「接続の確立」とみなします。接続が確立すると、ライブラリを動作終了状態にし、アドホックネットワークへの接続状態を維持したまま成功ステータス（<a href="../network/PSPNET_Adhoc_Discover-Reference-Japanese.htm#SCE_NET_ADHOC_DISCOVER_RESULT_OK">SCE_NET_ADHOC_DISCOVER_RESULT_OK</a>）を返します。<br><br>アドホックネットワークへの接続フェーズを、ライブラリ起動時にアプリケーションから指定された時間続けても接続を確立できない場合には、ライブラリを動作終了状態にし、探索・接続のリトライが必要なことを示すステータス（<a href="../network/PSPNET_Adhoc_Discover-Reference-Japanese.htm#SCE_NET_ADHOC_DISCOVER_RESULT_TRY_AGAIN">SCE_NET_ADHOC_DISCOVER_RESULT_TRY_AGAIN</a>）を返します。<br><br>WLANスイッチがオフになったなど、何かしらの接続エラーが発生した場合には、ライブラリを動作終了状態にし、エラーコードを返します。<br><br>またAPI呼び出しによる接続の中断も可能です。API呼び出しで中断が要求された場合には、ライブラリを動作終了状態にし、ライブラリの実行がキャンセルされたことを示すステータス（<a href="../network/PSPNET_Adhoc_Discover-Reference-Japanese.htm#SCE_NET_ADHOC_DISCOVER_RESULT_CANCELED">SCE_NET_ADHOC_DISCOVER_RESULT_CANCELED</a>）を返します。<br><br>接続フェーズでは、ライブラリ内部でCreateとScanを繰り返すので、アプリケーションがadhocctlイベントハンドラを登録している場合、アドホックディスカバライブラリ実行中にSCE_NET_ADHOCCTL_EVENT_SCAN, SCE_NET_ADHOCCTL_EVENT_CONNECT, SCE_NET_ADHOCCTL_EVENT_DISCONNECTなどのadhocctlイベントが通知されます。しかし、これらはアドホックディスカバライブラリ内部で扱うので、アプリケーションがこれらのイベントを扱う必要はありません。アプリケーションはアドホックディスカバライブラリが動作終了状態になった時に返されるステータスのみを扱います。<br><br></div>

<div align=center>
<p>
<img src="gif/PSPNET_Adhoc_Discover-Overview-Japanese007.gif">
</div>
<br>
<div style="margin-left:50px;"><br></div>

<!-- sce_fignum -->
<div align=center>
<p>
<b>図 7 アドホックネットワークへの接続フェーズ（接続確立成功）</b><br>
</div>
<br>
<div style="margin-left:50px;"><br></div>

<!-- sce_hd3 -->
<a name="Heading3_3">
<h2>
 3 <!-- hp --><b>使用手順の概略</b>
<hr noshade>
</h2>

<div style="margin-left:50px;">アドホックディスカバライブラリを使用するためには、事前にアドホックモード通信プロトコルを使用する準備（pspnet, pspnet_adhoc, pspnet_adhocctlモジュールの初期化）が完了している必要があります。<br>アドホックモード通信プロトコルの使用に関する初期化処理については、「PSP&reg;ネットワークライブラリ概要ドキュメント」を参照してください。<br></div>

<!-- sce_hd4 -->
<a name="Heading4_3_1">
<h3>
<a href="#Heading3_3"> 3. </a>1 
<!-- hp1 --><b>ライブラリの起動から終了まで</b><br>
</a>
</h3>
<div style="margin-left:50px;">アドホックディスカバライブラリを使用するアプリケーションは、大きく分けて次の4つの処理を行います。<br><br></div>
<div style="margin-left:55px;"><ol>
<li VALUE=1> ライブラリの初期化と起動処理<br><a href="../network/PSPNET_Adhoc_Discover-Reference-Japanese.htm#sceNetAdhocDiscoverInitStart">sceNetAdhocDiscoverInitStart</a>();</li>
<li VALUE=2> フレーム毎の処理とステータスの取得<br>while () {<br>　　<a href="../network/PSPNET_Adhoc_Discover-Reference-Japanese.htm#sceNetAdhocDiscoverGetStatus">sceNetAdhocDiscoverGetStatus</a>();<br>　　<a href="../network/PSPNET_Adhoc_Discover-Reference-Japanese.htm#sceNetAdhocDiscoverUpdate">sceNetAdhocDiscoverUpdate</a>();<br>}</li>
<li VALUE=3> 動作終了状態の処理<br>// 返り値をチェックし処理する</li>
<li VALUE=4> ライブラリの終了処理<br><a href="../network/PSPNET_Adhoc_Discover-Reference-Japanese.htm#sceNetAdhocDiscoverTerm">sceNetAdhocDiscoverTerm</a>();<br>// (3)で<a href="../network/PSPNET_Adhoc_Discover-Reference-Japanese.htm#SCE_NET_ADHOC_DISCOVER_RESULT_TRY_AGAIN">SCE_NET_ADHOC_DISCOVER_RESULT_TRY_AGAIN</a>が返された場合には、<br>// ライブラリ終了処理後、(1)から再試行することもある。</li>
</ol></div>
<div style="margin-left:50px;"><br>以降では、上記4つの各処理とライブラリの中断処理について詳細を説明します。<br><br></div>

<!-- sce_hd5 -->
<div style="margin-left:40px;"><a name="Heading5_3_1_1"><h4>
(1)&nbsp;<b>ライブラリの初期化と起動</b><br></h4>
</a></div>
<div style="margin-left:67px;"><a href="../network/PSPNET_Adhoc_Discover-Reference-Japanese.htm#sceNetAdhocDiscoverInitStart">sceNetAdhocDiscoverInitStart</a>()を呼び出してライブラリの初期化と起動を行います。このときに引数として次に示すパラメータを設定します。<br><br></div>
        <div style="margin-left:80px;"><pre><font size=3>struct <a href="../network/PSPNET_Adhoc_Discover-Reference-Japanese.htm#SceNetAdhocDiscoverParam">SceNetAdhocDiscoverParam</a> {
	int mode;
    struct <a href="../network/PSPNET_Adhocctl-Reference-Japanese.htm#SceNetAdhocctlGroupName">SceNetAdhocctlGroupName</a> group_name;
	unsigned int timeout;
    int result;
};
</font></pre></div>
<div style="margin-left:67px;"><br></div>
</ol>
<div style="margin-left:40px;"><ul>
<li> mode<br>探索フェーズで実行する探索モード
</ul></div>
<div style="margin-left:70px;"><ul>
<li> <a href="../network/PSPNET_Adhoc_Discover-Reference-Japanese.htm#SCE_NET_ADHOC_DISCOVER_MODE_HOSTDISCOVER">SCE_NET_ADHOC_DISCOVER_MODE_HOSTDISCOVER</a>
<li> <a href="../network/PSPNET_Adhoc_Discover-Reference-Japanese.htm#SCE_NET_ADHOC_DISCOVER_MODE_WOL">SCE_NET_ADHOC_DISCOVER_MODE_WOL</a>
</ol></div>
<div style="margin-left:40px;"><ul>
<li> group_name<br>探索・接続するアドホックネットワークのグループ名
<li> timeout<br>接続フェーズがタイムアウトするまでの時間（秒）。指定時間以内に接続が確立できない場合には、ライブラリは動作終了状態となり、<a href="../network/PSPNET_Adhoc_Discover-Reference-Japanese.htm#SCE_NET_ADHOC_DISCOVER_RESULT_TRY_AGAIN">SCE_NET_ADHOC_DISCOVER_RESULT_TRY_AGAIN</a>を返します。<br><a href="../network/PSPNET_Adhoc_Discover-Reference-Japanese.htm#SCE_NET_ADHOC_DISCOVER_RESULT_TRY_AGAIN">SCE_NET_ADHOC_DISCOVER_RESULT_TRY_AGAIN</a>が返された場合は、ライブラリの初期化と起動からやりなおしてください。
<li> result<br>ライブラリが動作終了状態になったときの返り値
</ul>
</ul></div>
<div style="margin-left:67px;"><br>以下のプログラム例は、探索モードとしてWoLモードを指定し、ライブラリを起動する場合の例です。<br><br></div>
        <div style="margin-left:80px;"><pre><font size=3>// ここまでにアドホックモードで必要なライブラリの初期化処理が
// 完了しているものとします

struct <a href="../network/PSPNET_Adhocctl-Reference-Japanese.htm#SceNetAdhocctlGroupName">SceNetAdhocctlGroupName</a>  group_name;
struct <a href="../network/PSPNET_Adhoc_Discover-Reference-Japanese.htm#SceNetAdhocDiscoverParam">SceNetAdhocDiscoverParam</a> param;

// group_nameには適当なグループ名が設定されているものとします

// ライブラリの初期化と起動
param.mode = <a href="../network/PSPNET_Adhoc_Discover-Reference-Japanese.htm#SCE_NET_ADHOC_DISCOVER_MODE_WOL">SCE_NET_ADHOC_DISCOVER_MODE_WOL</a>; 
memcpy(param.group_name, group_name, sizeof(group_name));
param.timeout = DISCOVER_TIMEOUT;

ret = <a href="../network/PSPNET_Adhoc_Discover-Reference-Japanese.htm#sceNetAdhocDiscoverInitStart">sceNetAdhocDiscoverInitStart</a>(&amp;param);
if (ret &lt; 0) {
	// エラー処理
}
</font></pre></div>

<!-- sce_hd5 -->
<div style="margin-left:40px;"><a name="Heading5_3_1_2"><h4>
(2)&nbsp;<b>フレーム毎の処理とステータスの取得</b><br></h4>
</a></div>
<div style="margin-left:67px;">ライブラリ起動後は処理ループの中で、フレーム毎の処理を行います。<a href="../network/PSPNET_Adhoc_Discover-Reference-Japanese.htm#sceNetAdhocDiscoverGetStatus">sceNetAdhocDiscoverGetStatus</a>()を呼び出すことによりライブラリの状態を監視し、動作終了状態（<a href="../network/PSPNET_Adhoc_Discover-Reference-Japanese.htm#SCE_NET_ADHOC_DISCOVER_STATUS_FINISHED">SCE_NET_ADHOC_DISCOVER_STATUS_FINISHED</a>）になるのを待機します。ライブラリの状態が実行中（<a href="../network/PSPNET_Adhoc_Discover-Reference-Japanese.htm#SCE_NET_ADHOC_DISCOVER_STATUS_RUNNING">SCE_NET_ADHOC_DISCOVER_STATUS_RUNNING</a>）なら、<a href="../network/PSPNET_Adhoc_Discover-Reference-Japanese.htm#sceNetAdhocDiscoverUpdate">sceNetAdhocDiscoverUpdate</a>()を呼び出してフレーム毎の処理を行います。<br><br></div>
        <div style="margin-left:80px;"><pre><font size=3>while (1) {
	int status;

	status = <a href="../network/PSPNET_Adhoc_Discover-Reference-Japanese.htm#sceNetAdhocDiscoverGetStatus">sceNetAdhocDiscoverGetStatus</a>();
	if (status == <a href="../network/PSPNET_Adhoc_Discover-Reference-Japanese.htm#SCE_NET_ADHOC_DISCOVER_STATUS_RUNNING">SCE_NET_ADHOC_DISCOVER_STATUS_RUNNING</a>) {
		<a href="../network/PSPNET_Adhoc_Discover-Reference-Japanese.htm#sceNetAdhocDiscoverUpdate">sceNetAdhocDiscoverUpdate</a>();
		continue;
	}
	if (status == <a href="../network/PSPNET_Adhoc_Discover-Reference-Japanese.htm#SCE_NET_ADHOC_DISCOVER_STATUS_FINISHED">SCE_NET_ADHOC_DISCOVER_STATUS_FINISHED</a>) {
		// 動作終了状態の処理（次項参照）
		// ライブラリの終了処理（次々項参照）
	}
}
</font></pre></div>

<!-- sce_hd5 -->
<div style="margin-left:40px;"><a name="Heading5_3_1_3"><h4>
(3)&nbsp;<b>動作終了状態の処理</b><br></h4>
</a></div>
<div style="margin-left:67px;">ライブラリが動作終了の状態になったら、パラメータのresultを参照します。<br></div>
<div style="margin-left:40px;"><ul>
<li> <a href="../network/PSPNET_Adhoc_Discover-Reference-Japanese.htm#SCE_NET_ADHOC_DISCOVER_RESULT_OK">SCE_NET_ADHOC_DISCOVER_RESULT_OK</a><br>成功（端末を発見した）。アドホックネットワークへの接続を維持した状態で返ります。
<li> <a href="../network/PSPNET_Adhoc_Discover-Reference-Japanese.htm#SCE_NET_ADHOC_DISCOVER_RESULT_CANCELED">SCE_NET_ADHOC_DISCOVER_RESULT_CANCELED</a><br>リクエストにより停止された。
<li> <a href="../network/PSPNET_Adhoc_Discover-Reference-Japanese.htm#SCE_NET_ADHOC_DISCOVER_RESULT_TRY_AGAIN">SCE_NET_ADHOC_DISCOVER_RESULT_TRY_AGAIN</a><br>近傍端末を発見したが、一定時間（timeout）以内に接続を確立できなかった。<br>再度探索を開始するために、ライブラリの初期化と起動からやりなおしてください。
<li> <a href="../network/PSPNET_Adhoc_Discover-Reference-Japanese.htm#SCE_NET_ADHOC_DISCOVER_RESULT_ABORTED_SEARCH_BY_NORMAL_RESUME">SCE_NET_ADHOC_DISCOVER_RESULT_ABORTED_SEARCH_BY_NORMAL_RESUME</a><br>WoLモード探索中に、WoL以外の要因（電源スイッチの押上げなど）によりPSP&reg;がレジュームされ、探索が中断された。
<li> result &lt; 0<br>アドホックディスカバライブラリ動作中に発生したpspnet_adhocctlのERRORイベントのエラーコード。
</ul></div>

<!-- sce_hd5 -->
<div style="margin-left:40px;"><a name="Heading5_3_1_4"><h4>
(4)&nbsp;<b>ライブラリの終了処理</b><br></h4>
</a></div>
<div style="margin-left:67px;">ライブラリが動作終了状態になった後、<a href="../network/PSPNET_Adhoc_Discover-Reference-Japanese.htm#sceNetAdhocDiscoverTerm">sceNetAdhocDiscoverTerm</a>()を呼び出します。<br><br></div>

<!-- sce_hd5 -->
<div style="margin-left:40px;"><a name="Heading5_3_1_5"><h4>
(5)&nbsp;<b>ライブラリの中断</b><br></h4>
</a></div>
<div style="margin-left:67px;">ライブラリ起動中に探索・接続の中断を行うには、<a href="../network/PSPNET_Adhoc_Discover-Reference-Japanese.htm#sceNetAdhocDiscoverStop">sceNetAdhocDiscoverStop</a>()を呼び出します。<a href="../network/PSPNET_Adhoc_Discover-Reference-Japanese.htm#sceNetAdhocDiscoverStop">sceNetAdhocDiscoverStop</a>()を呼び出すと中断処理が行われ、ライブラリは動作終了状態になります。アプリケーションは、ライブラリが動作終了状態になるのを待ち合わせた後に、<a href="../network/PSPNET_Adhoc_Discover-Reference-Japanese.htm#sceNetAdhocDiscoverTerm">sceNetAdhocDiscoverTerm</a>()を呼び出してライブラリを終了させます。<br></div>

<!-- sce_hd6 -->
<a name="Heading6_3_1_5_1">
<div style="margin-left:63px;"><h4><b>WoLモードでの探索の中断</b><br><br></h4></a></div>
<div style="margin-left:80px;">WoLモードでの探索中はPSP&reg;がサスペンド状態であるため、API呼び出しによる探索の中断はできません。ただし、WoLモードでの探索中に電源スイッチ押し上げによるレジュームが発生すると、自動的にWoLモードの探索は中断され、ライブラリは動作終了状態に遷移します。その際、アプリケーションには、adhocctlのイベントハンドラにWOL_ABORTイベントが通知されるとともに、ライブラリの終了ステータスとして<a href="../network/PSPNET_Adhoc_Discover-Reference-Japanese.htm#SCE_NET_ADHOC_DISCOVER_RESULT_ABORTED_SEARCH_BY_NORMAL_RESUME">SCE_NET_ADHOC_DISCOVER_RESULT_ABORTED_SEARCH_BY_NORMAL_RESUME</a>が返されます。<br></div>

<!-- sce_hd4 -->
<a name="Heading4_3_2">
<h3>
<a href="#Heading3_3"> 3. </a>2 
<!-- hp1 --><b>アプリケーション作成において必要と想定される機能や処理</b><br>
</a>
</h3>
<div style="margin-left:50px;">前項の「ライブラリの起動から終了まで」の操作のみで、近傍端末の探索とアドホックネットワークへの接続を完了することができます。本項では、アプリケーションを作成する上で必要と想定される機能や処理について説明します。<br><br>本ライブラリのサンプルプログラム（devkit/sample/net/adhoc/adhoc_discover/wol_picture）も併せて御参照ください。<br></div>

<!-- sce_hd5 -->
<div style="margin-left:40px;"><a name="Heading5_3_2_1"><h4>
(1)&nbsp;<b>近傍端末の発見を知る方法</b><br></h4>
</a></div>
<div style="margin-left:67px;">pspnet_adhocctlイベントハンドラを登録していれば、アドホックディスカバライブラリの実行中に近傍端末を発見した場合、端末の発見を示すイベントを受け取ることができます。次に各探索モードにおけるイベントとイベントハンドラの例を示します。<br><br></div>
<div style="margin-left:40px;"><ul>
<li> HostDiscoverモード　：　SCE_NET_ADHOCCTL_EVENT_HOSTDISCOVER
<li> WoLモード　　　　　：　SCE_NET_ADHOCCTL_EVENT_WOL
</ul></div>
<div style="margin-left:67px;"><br></div>
        <div style="margin-left:80px;"><pre><font size=3>// pspnet_adhocctl　イベントハンドラ
void adhocctl_handler(int event, int error, void *arg)
{
	if (event == SCE_NET_ADHOCCTL_EVENT_ERROR) {
	}
	else if ( ...
	
	}
	else if (event == SCE_NET_ADHOCCTL_EVENT_HOSTDISCOVER) {
		// HostDiscoverモードで探索し、近傍端末を発見した
		// アドホックディスカバライブラリは接続フェーズに入っている
	}
	else if (event == SCE_NET_ADHOCCTL_EVENT_WOL) {
		// WoLモードで探索し、近傍端末を発見した
		// アドホックディスカバライブラリは接続フェーズに入っている
	}
}
</font></pre></div>
<div style="margin-left:67px;"><br>アプリケーションが、探索している時と接続処理を行っている時でメッセージ表示などの処理を変更させる場合などに利用することができます。<br><br></div>

<div align=center>
<p>
<img src="gif/PSPNET_Adhoc_Discover-Overview-Japanese008.gif">
</div>
<br>
<div style="margin-left:67px;"><br></div>

<!-- sce_fignum -->
<div align=center>
<p>
<b>図 8 近傍端末を発見した時通知されるadhocctlイベント</b><br>
</div>
<br>

<!-- sce_hd5 -->
<div style="margin-left:40px;"><a name="Heading5_3_2_2"><h4>
(2)&nbsp;<b>WoLレジュームとWoL以外の要因（電源スイッチなど）によるレジュームの区別</b><br></h4>
</a></div>
<div style="margin-left:67px;">WoLモードによる探索で近傍端末を発見しPSP&reg;がレジュームされたのか、WoLモードによる探索中で近傍端末の発見前にユーザが電源スイッチを押し上げるなどでPSP&reg;をレジュームさせたのかは、アドホックディスカバライブラリの動作終了状態時に返される終了ステータスの値で区別することができます。<br><br>WoLモード探索で近傍端末を発見しレジュームした場合は、その後の接続フェーズを経て接続確立の成否を示すステータスが返されます。WoLモードによる探索中に電源スイッチを押し上げPSP&reg;をレジュームさせた場合、pspnet_adhocctlイベントハンドラを通じてSCE_NET_ADHOCCTL_EVENT_WOL_ABORTイベントが通知されるとともに、ライブラリは動作終了状態に遷移し、<a href="../network/PSPNET_Adhoc_Discover-Reference-Japanese.htm#SCE_NET_ADHOC_DISCOVER_RESULT_ABORTED_SEARCH_BY_NORMAL_RESUME">SCE_NET_ADHOC_DISCOVER_RESULT_ABORTED_SEARCH_BY_NORMAL_RESUME</a>というステータスが返されます。<br><br>WoLモード探索で近傍端末を発見したこと自体を知りたい場合は、前項で示したように、pspnet_adhocctlイベントハンドラを通じてSCE_NET_ADHOCCTL_EVENT_WOLイベントを受け取ります。SCE_NET_ADHOCCTL_EVENT_WOLイベントを受け取った場合は、WoLによるレジュームが発生（近傍端末を発見）したことを示します。<br><br>アプリケーションが、近傍端末を発見したときと、発見する前にユーザの操作により探索が中断されたときで処理を変更させる場合などに利用することができます。<br><br>サンプルプログラム（devkit/sample/net/adhoc/adhoc_discover/wol_picture）では、WoLレジュームが発生した場合には発見端末とピクチャデータの送受信を行い、電源スイッチによるレジュームが発生した場合には、「通信相手を発見できませんでした。通信相手の探索を中断します。」と表示し、ゲームに戻ります。<br></div>

<!-- sce_hd5 -->
<div style="margin-left:40px;"><a name="Heading5_3_2_3"><h4>
(3)&nbsp;<b>API呼び出しによるサスペンド処理</b><br></h4>
</a></div>
<div style="margin-left:67px;"><a href="../network/PSPNET_Adhoc_Discover-Reference-Japanese.htm#sceNetAdhocDiscoverRequestSuspend">sceNetAdhocDiscoverRequestSuspend</a>()を呼び出すことで、アプリケーションからPSP&reg;をサスペンドさせることができます。このAPIによるサスペンドではWoLの設定はされず、手動で電源スイッチを押し上げることによるサスペンドと同様です。<br><br></div>
        <div style="margin-left:80px;"><pre><font size=3>ret = <a href="../network/PSPNET_Adhoc_Discover-Reference-Japanese.htm#sceNetAdhocDiscoverRequestSuspend">sceNetAdhocDiscoverRequestSuspend</a>();
if (ret &lt; 0) {
	// エラー処理
}

// &quot;PSP&quot;がサスペンドされる
</font></pre></div>
<div style="margin-left:67px;"><br>WoLモードによる探索を利用する場合、近傍端末の発見時にユーザが不在であることが考えられます。そのような状況下では、WoLモードで探索後に発見した端末と何かしらの処理を行った後、通常のサスペンドモードに入り電力消費を抑制することが必要となります（図 6）。<a href="../network/PSPNET_Adhoc_Discover-Reference-Japanese.htm#sceNetAdhocDiscoverRequestSuspend">sceNetAdhocDiscoverRequestSuspend</a>()はそのような状況での利用を想定したものです。<br>したがって、<a href="../network/PSPNET_Adhoc_Discover-Reference-Japanese.htm#sceNetAdhocDiscoverRequestSuspend">sceNetAdhocDiscoverRequestSuspend</a>()によるサスペンドを実行できるのは、事前にアドホックディスカバライブラリを利用してWoLモードによる探索を行い、近傍端末の発見によりレジュームされ、さらに<a href="../network/PSPNET_Adhoc_Discover-Reference-Japanese.htm#sceNetAdhocDiscoverTerm">sceNetAdhocDiscoverTerm</a>()でライブラリが終了された後に限ります。<br><br>サンプルプログラム（devkit/sample/net/adhoc/adhoc_discover/wol_picture）では、発見端末とのピクチャの交換終了後「30秒後に通常のサスペンドモードに入ります。」というメッセージを表示し、30秒間ユーザの操作がなければサスペンドモードに入ります。その後ユーザが電源スイッチを押し上げレジュームさせると、端末を発見しピクチャの交換が行われたことを表示します。<br><br></div>

<!-- sce_hd3 -->
<a name="Heading3_4">
<h2>
 4 <!-- hp --><b>adhocctlの内部状態の遷移</b>
<hr noshade>
</h2>

<div style="margin-left:50px;">アドホックディスカバライブラリを利用し、HostDiscoverモードまたはWoLモードで探索を開始するとき、adhocctlの内部状態が「DISCONNECTED状態」でなくはなりません。HostDiscoverモード、WoLモードで探索を開始すると、DISCONNECTED状態からそれぞれ「HOSTDISCOVER状態」「WOL状態」に遷移します。<br><br>HOSTDISCOVER状態、WOL状態のとき近傍の端末を発見すると、SCE_NET_ADHOCCTL_EVENT_HOSTDISCOVER, SCE_NET_ADHOCCTL_EVENT_WOLイベントを通知し、DISCONNECTED状態に戻ります。探索がキャンセルされた場合には、DISCONNECTイベントを通知し、DISCONNECTED状態に戻ります。探索中にエラーが発生した場合には、エラーイベントを通知し、DISCONNECTED状態に戻ります。また、WoL探索中に電源スイッチの押し上げなどの要因で探索が中断された場合には、SCE_NET_ADHOCCTL_EVENT_WOL_ABORTイベントを通知し、DISCONNECTED状態に戻ります。<br><br>図 9は、HostDiscoverモード、WoLモードによる探索時のadhocctlの内部状態の遷移を表しています。「PSPNET概要」の図2（pspnet_adhocctl状態遷移図）も併せて御参照ください。<br><br></div>

<div align=center>
<p>
<img src="gif/PSPNET_Adhoc_Discover-Overview-Japanese009.gif">
</div>
<br>
<div style="margin-left:50px;"><br></div>

<!-- sce_fignum -->
<div align=center>
<p>
<b>図 9 HostDiscoverモード、WoLモード探索におけるadhocctl内部状態の遷移</b><br>
</div>
<br>

<!-- sce_hd3 -->
<a name="Heading3_5">
<h2>
 5 <!-- hp --><b>備考</b>
<hr noshade>
</h2>


<!-- sce_hd4 -->
<a name="Heading4_5_1">
<h3>
<a href="#Heading3_5"> 5. </a>1 
<!-- hp1 --><b>API呼び出しに必要なスタックサイズ</b><br>
</a>
</h3>
<div style="margin-left:50px;">アドホックディスカバライブラリのAPI呼び出しに必要なサイズは、4096バイト（SCE_NET_PSPNET_ADHOC_DISCOVER_LEAST_STACK_SIZE）です。スタックサイズが不足の場合は<a href="../network/PSPNET_Error-Reference-Japanese.htm#SCE_ERROR_NET_INSUFFICIENT_STACKSIZE">SCE_ERROR_NET_INSUFFICIENT_STACKSIZE</a>のエラーが返ります。<br></div>

<!-- sce_hd4 -->
<a name="Heading4_5_2">
<h3>
<a href="#Heading3_5"> 5. </a>2 
<!-- hp1 --><b>sceNetAdhocDiscoverRequestSuspend()の使用制限</b><br>
</a>
</h3>
<div style="margin-left:50px;">アプリケーションからPSP&reg;をサスペンドさせることができる<a href="../network/PSPNET_Adhoc_Discover-Reference-Japanese.htm#sceNetAdhocDiscoverRequestSuspend">sceNetAdhocDiscoverRequestSuspend</a>()の呼び出しには制限が設けられています。WoLモードでの近傍端末の探索で発見した端末との通信処理の後、ユーザ不在中の電力消費を回避する必要がある場合にのみ、使用することができます。<br></div>

<!-- sce_hd4 -->
<a name="Heading4_5_3">
<h3>
<a href="#Heading3_5"> 5. </a>3 
<!-- hp1 --><b>HostDiscoverモード、WoLモード探索時のバッテリ消費量</b><br>
</a>
</h3>

<!-- sce_hd5 -->
<div style="margin-left:40px;"><a name="Heading5_5_3_1"><h4>
(1)&nbsp;<b>HostDiscoverモード探索</b><br></h4>
</a></div>
<div style="margin-left:67px;">HostDiscoverモードによる探索はゲーム実行中に行われるため、探索時のバッテリ消費量はアプリケーションに依存します。参考値として、下記のプログラムと実行条件により、1800mAhのバッテリにおいて満充電状態からHostDiscoverモード探索を開始し、ローバッテリ状態となるまでの時間を示します。<br><br></div>
<div style="margin-left:40px;"><ul>
<li> 実行プログラム　　：　devkit/sample/net/adhoc/adhoc_discover/moonball
<li> 実行条件　　　　　：　自動バックライトOFF機能を無効
<li> 連続探索可能時間　：　6時間42分53秒
</ul></div>

<!-- sce_hd5 -->
<div style="margin-left:40px;"><a name="Heading5_5_3_2"><h4>
(2)&nbsp;<b>WoLモード探索</b><br></h4>
</a></div>
<div style="margin-left:67px;">WoLモードによる探索はPSP&reg;のサスペンド中に行われるため、探索時のバッテリ消費量はアプリケーションに依存せず、常に一定の消費量で探索可能です。参考値として、1800mAhのバッテリにおいて満充電状態からWoLモード探索を開始し、ローバッテリ状態となるまでの時間を示します。<br><br></div>
<div style="margin-left:40px;"><ul>
<li> 連続探索可能時間　：　46時間16分02秒
</ul></div>
<br>
<p><p><hr>
<div ALIGN="right">
    &copy;2009 Sony Computer Entertainment Inc.  All Rights Reserved.<br>
    SCE CONFIDENTIAL
</div>
</body>
</html>
